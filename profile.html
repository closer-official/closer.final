<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOSER | Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { gold: '#C5A059', dark: '#111111', darker: '#0a0a0a' },
                    fontFamily: { cinzel: ['Cinzel', 'serif'], noto: ['Noto Serif JP', 'serif'] },
                }
            }
        }
    </script>
    <style>
        body { background-color: #000; color: #fff; font-family: 'Noto Serif JP', serif; }
        .menu-item { border-bottom: 1px solid #222; }
        .menu-item:hover { color: #C5A059; }
    </style>
</head>
<body class="bg-black">
    <div class="min-h-screen flex flex-col">
        <header class="fixed top-0 left-0 right-0 bg-black bg-opacity-90 backdrop-blur-sm z-50 flex justify-between items-center p-4 border-b border-gray-800">
            <div class="text-xl font-cinzel text-gold">PROFILE</div>
            <a href="timeline.html" class="text-sm border border-gray-600 px-3 py-1 hover:border-gold hover:text-gold transition">BACK</a>
        </header>

        <main class="flex-1 pt-24 px-6 pb-12 text-center">
            <div class="relative w-28 h-28 mx-auto mb-6 group">
                <img id="profile-img" src="https://via.placeholder.com/150/111111/C5A059?text=USER" alt="Profile" class="w-full h-full rounded-full border-2 border-gold object-cover">
                
                <label for="file-input" class="absolute bottom-0 right-0 bg-gold w-8 h-8 rounded-full flex items-center justify-center cursor-pointer hover:bg-yellow-600 transition shadow-lg">
                    <span class="text-black text-sm">üì∑</span>
                </label>
                <input type="file" id="file-input" accept="image/*" class="hidden">
                
                <div id="upload-loading" class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center hidden">
                    <div class="animate-spin h-6 w-6 border-2 border-gold rounded-full border-t-transparent"></div>
                </div>
            </div>
            
            <div class="flex items-center justify-center gap-2 mb-2">
                <h2 id="profile-name" class="text-xl font-cinzel text-gold">LOADING...</h2>
                <span id="role-badge" class="text-[10px] px-2 py-0.5 border border-gray-500 rounded font-cinzel tracking-wider text-gray-400">
                    -
                </span>
            </div>
            
            <p id="profile-uid" class="text-gray-500 text-xs mb-8 font-mono">UID: ...</p>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-dark p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 font-cinzel mb-1">RANK</div>
                    <div id="stat-rank" class="text-lg text-gold font-cinzel">-</div>
                </div>
                <div class="bg-dark p-4 border border-gray-800">
                    <div class="text-xs text-gray-500 font-cinzel mb-1">SKILL SCORE</div>
                    <div class="text-lg font-cinzel">0</div>
                </div>
            </div>

            <div class="text-left mb-8">
                <div class="menu-item flex justify-between items-center py-4 cursor-pointer"><span>Ëá™Â∑±Á¥π‰ªãÊñá„ÅÆÁ∑®ÈõÜ</span><span>&gt;</span></div>
                <div class="menu-item flex justify-between items-center py-4"><span>ÈÄöÁü•Ë®≠ÂÆö</span><span>ON</span></div>
            </div>

            <button id="logout-btn" class="w-full py-3 border border-red-600 text-red-600 font-cinzel hover:bg-red-600 hover:text-white transition mb-8">LOGOUT</button>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmPN0z032Uo_ONsronn3smkIixRnBReJw",
            authDomain: "closer-official.firebaseapp.com",
            projectId: "closer-official",
            storageBucket: "closer-official.firebasestorage.app",
            messagingSenderId: "1039215613610",
            appId: "1:1039215613610:web:540ef7a026714e28dbe2d3",
            measurementId: "G-LYK0THB2Z2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);

        const profileImg = document.getElementById('profile-img');
        const profileName = document.getElementById('profile-name');
        const profileUid = document.getElementById('profile-uid');
        const roleBadge = document.getElementById('role-badge');
        const statRank = document.getElementById('stat-rank');
        const fileInput = document.getElementById('file-input');
        const uploadLoading = document.getElementById('upload-loading');
        const logoutBtn = document.getElementById('logout-btn');

        let currentUser = null;

        // ‚òÖ„ÉÜ„Çπ„ÉàÁî®Ë®≠ÂÆöÔºö„Åì„Åì„ÅßÂΩπÂâ≤„Å®„É©„É≥„ÇØ„ÇíÂ§âÊõ¥„Åó„Å¶Á¢∫Ë™ç„Åß„Åç„Åæ„Åô
        // ROLE: 'PLAYER', 'AUDITOR', 'OBSERVER'
        // RANK: 'SS', 'S', 'A', 'B', 'C'
        const TEST_USER_ROLE = 'PLAYER'; 
        const TEST_USER_RANK = 'S';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                profileName.innerText = user.displayName || "NO NAME";
                profileUid.innerText = `UID: ${user.uid}`;
                if (user.photoURL) {
                    profileImg.src = user.photoURL;
                }

                // ‚ñº‚ñº‚ñº ÂΩπÂâ≤„Å®„É©„É≥„ÇØ„ÅÆË°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ ‚ñº‚ñº‚ñº
                
                // 1. ÂΩπÂâ≤„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫
                roleBadge.innerText = TEST_USER_ROLE;
                if(TEST_USER_ROLE === 'PLAYER') {
                    roleBadge.className = "text-[10px] px-2 py-0.5 border border-gold text-gold rounded font-cinzel tracking-wider";
                } else if(TEST_USER_ROLE === 'AUDITOR') {
                    roleBadge.className = "text-[10px] px-2 py-0.5 border border-blue-400 text-blue-400 rounded font-cinzel tracking-wider";
                } else {
                    roleBadge.className = "text-[10px] px-2 py-0.5 border border-gray-500 text-gray-500 rounded font-cinzel tracking-wider";
                }

                // 2. „É©„É≥„ÇØ„ÅÆË°®Á§∫ÔºàOBSERVER„ÅØË°®Á§∫„Å™„ÅóÔºâ
                if (TEST_USER_ROLE === 'OBSERVER') {
                    statRank.innerText = "-";
                    statRank.classList.remove('text-gold');
                    statRank.classList.add('text-gray-500');
                } else {
                    statRank.innerText = TEST_USER_RANK;
                    statRank.classList.add('text-gold');
                }

            } else {
                window.location.href = "index.html";
            }
        });

        // ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;

            if (!file.type.startsWith('image/')) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            try {
                uploadLoading.classList.remove('hidden');
                const fileExt = file.name.split('.').pop();
                const fileName = `profile_${Date.now()}.${fileExt}`;
                const storageRef = ref(storage, `profile_images/${currentUser.uid}/${fileName}`);

                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                await updateProfile(currentUser, { photoURL: downloadURL });
                profileImg.src = downloadURL + "?t=" + new Date().getTime();
                alert("„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ");

            } catch (error) {
                console.error("Upload failed:", error);
                alert("ÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
            } finally {
                uploadLoading.classList.add('hidden');
                fileInput.value = '';
            }
        });

        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        logoutBtn.addEventListener('click', async () => {
            if (confirm("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü")) {
                await signOut(auth);
                window.location.href = "index.html";
            }
        });
    </script>
</body>
</html>