<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOSER | Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            text-align: center;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 5px;
            font-family: 'Cinzel', serif;
        }
        .stat-value {
            font-size: 1.2rem;
            color: var(--text-color);
            font-family: 'Cinzel', serif;
        }
        .menu-list {
            text-align: left;
            margin-bottom: 30px;
        }
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #222;
            color: #ddd;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .menu-item:hover { color: var(--gold-color); }
        .footer-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            font-size: 0.7rem;
        }
        .footer-links a { color: #666; text-decoration: none; }
    </style>
</head>
<body>
    <header>
        <div class="logo gold-text">PROFILE</div>
        <a href="timeline.html" class="alpha-btn">BACK</a>
    </header>

    <div class="container" style="padding-top: 80px; text-align: center;">
        
        <div style="position: relative; width: 100px; height: 100px; margin: 0 auto 15px;">
            <img id="profile-img" src="" style="width: 100%; height: 100%; border-radius: 50%; border: 2px solid #C5A059; object-fit: cover;">
            <label for="file-input" style="position: absolute; bottom: 0; right: 0; background: #C5A059; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 1rem; color: #000;">ğŸ“·</span>
            </label>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>

        <button id="upload-btn" class="alpha-btn" style="display:none; margin: 0 auto 15px; font-size:0.7rem;">ç”»åƒä¿å­˜</button>
        
        <h2 id="profile-name" class="gold-text" style="margin-bottom: 5px;">LOADING...</h2>
        <p id="profile-bio" style="color: #888; font-size: 0.8rem; margin-bottom: 20px; padding: 0 20px;">
            ...
        </p>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">RANK</div>
                <div id="stat-rank" class="stat-value gold-text">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">SKILL SCORE</div>
                <div id="stat-score" class="stat-value">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">AMV</div>
                <div id="stat-amv" class="stat-value">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">CC (COIN)</div>
                <div id="stat-cc" class="stat-value">-</div>
            </div>
        </div>

        <div style="background: #1a1a1a; padding: 15px; border: 1px solid #444; margin-bottom: 30px; border-radius: 5px;">
            <div class="stat-label">REWARD BALANCE (JAY)</div>
            <div id="stat-reward" class="stat-value" style="font-size: 1.5rem;">Â¥0</div>
        </div>

        <div class="menu-list">
            <div class="menu-item" onclick="alert('è‡ªå·±ç´¹ä»‹ç·¨é›†æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™')">
                <span>è‡ªå·±ç´¹ä»‹æ–‡ã®ç·¨é›†</span> <span>&gt;</span>
            </div>
            <div class="menu-item" onclick="alert('ä¿å­˜æ¸ˆã¿æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“')">
                <span>ä¿å­˜æ¸ˆã¿æŠ•ç¨¿ (SAVED)</span> <span>&gt;</span>
            </div>
            <div class="menu-item" onclick="alert('ç¾åœ¨ã™ã¹ã¦ã®æŠ•ç¨¿ã¯å…¬é–‹è¨­å®šã§ã™')">
                <span>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (éµã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š)</span> <span>OFF</span>
            </div>
            <div class="menu-item" onclick="alert('ã‚¹ã‚«ã‚¦ãƒˆæ©Ÿèƒ½ãƒªãƒªãƒ¼ã‚¹å¾Œã«è¨­å®šå¯èƒ½ã§ã™')">
                <span>ã‚¹ã‚«ã‚¦ãƒˆè¨­å®š</span> <span>&gt;</span>
            </div>
            <div class="menu-item">
                <span>é€šçŸ¥è¨­å®š</span> <span>ON</span>
            </div>
            <div class="menu-item" onclick="alert('ç¾åœ¨åŠ å…¥ä¸­ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“')">
                <span>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†</span> <span>&gt;</span>
            </div>
        </div>

        <div class="footer-links">
            <a href="javascript:void(0)">åˆ©ç”¨è¦ç´„</a>
            <a href="javascript:void(0)">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
            <a href="javascript:void(0)">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a>
            <a href="javascript:void(0)">ã‚ˆãã‚ã‚‹è³ªå•</a>
            <a href="javascript:void(0)">è¿”é‡‘çª“å£</a>
        </div>

        <button id="logout-btn" class="btn btn-full" style="border-color: #ff4444; color: #ff4444; margin-bottom: 50px;">
            LOGOUT
        </button>

    </div>

    <script type="module">
        import { 
            auth, onAuthStateChanged, signOut, updateProfile, 
            storage, ref, uploadBytes, getDownloadURL,
            db, doc, getDoc, updateDoc 
        } from "./js/firebase-config.js";

        const els = {
            img: document.getElementById('profile-img'),
            name: document.getElementById('profile-name'),
            bio: document.getElementById('profile-bio'),
            rank: document.getElementById('stat-rank'),
            score: document.getElementById('stat-score'),
            amv: document.getElementById('stat-amv'),
            cc: document.getElementById('stat-cc'),
            reward: document.getElementById('stat-reward'),
            fileInput: document.getElementById('file-input'),
            uploadBtn: document.getElementById('upload-btn')
        };
        
        let currentUser = null;
        let selectedFile = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                els.img.src = user.photoURL || "https://via.placeholder.com/100?text=NO+IMG";
                els.name.innerText = user.displayName;

                // Firestoreã‹ã‚‰è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        els.bio.innerText = data.bio || "è‡ªå·±ç´¹ä»‹æ–‡ã¯ã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                        els.rank.innerText = (data.rank || "Standard").toUpperCase();
                        els.score.innerText = data.score_skill || 0;
                        els.amv.innerText = data.amv || 0;
                        els.cc.innerText = data.cc || 0;
                        els.reward.innerText = "Â¥" + (data.reward_bal || 0).toLocaleString();
                    }
                } catch (e) {
                    console.error("Data Load Error:", e);
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                els.img.src = URL.createObjectURL(file);
                els.uploadBtn.style.display = 'block';
            }
        });

        els.uploadBtn.addEventListener('click', async () => {
            if (!selectedFile || !currentUser) return;
            els.uploadBtn.innerText = "...";
            try {
                const storageRef = ref(storage, `users/${currentUser.uid}/profile.jpg`);
                await uploadBytes(storageRef, selectedFile);
                const photoURL = await getDownloadURL(storageRef);
                await updateProfile(currentUser, { photoURL });
                await updateDoc(doc(db, "users", currentUser.uid), { photoURL });
                alert("æ›´æ–°ã—ã¾ã—ãŸ");
                location.reload();
            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            if(confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) signOut(auth).then(() => window.location.href = "index.html");
        });
    </script>
</body>
</html>