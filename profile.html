<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOSER | Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="logo gold-text">PROFILE</div>
        <a href="timeline.html" class="alpha-btn">BACK</a>
    </header>

    <div class="container" style="padding-top: 100px; text-align: center;">
        
        <div style="position: relative; width: 120px; height: 120px; margin: 0 auto 20px;">
            <img id="profile-img" src="" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; border: 2px solid #C5A059; object-fit: cover;">
            
            <label for="file-input" style="position: absolute; bottom: 0; right: 0; background: #C5A059; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">
                <span style="font-size: 1.2rem; color: #000;">üì∑</span>
            </label>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>

        <button id="upload-btn" class="alpha-btn" style="display:none; margin: 0 auto 20px; background:var(--gold-color); color:#000; font-weight:bold;">
            Â§âÊõ¥„Çí‰øùÂ≠ò„Åô„Çã
        </button>
        
        <h2 id="profile-name" class="gold-text" style="margin-bottom: 10px; font-family:'Cinzel', serif;">LOADING...</h2>
        <p id="profile-email" style="color: #666; margin-bottom: 40px; font-size:0.9rem;">...</p>

        <div style="border-top:1px solid #333; margin: 30px 0;"></div>

        <button id="logout-btn" class="btn btn-full" style="max-width: 300px; margin: 0 auto; border-color: #ff4444; color: #ff4444; font-size:0.8rem;">
            LOGOUT
        </button>

    </div>

    <script type="module">
        import { 
            auth, onAuthStateChanged, signOut, updateProfile, 
            storage, ref, uploadBytes, getDownloadURL,
            db, doc, updateDoc 
        } from "./js/firebase-config.js";

        const img = document.getElementById('profile-img');
        const name = document.getElementById('profile-name');
        const email = document.getElementById('profile-email');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        
        let currentUser = null;
        let selectedFile = null;

        // 1. „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë™≠„ÅøËæº„Åø
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // ÁîªÂÉè„Åå„Å™„Åë„Çå„Å∞„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº
                img.src = user.photoURL || "https://via.placeholder.com/150/000000/FFFFFF/?text=NO+IMG";
                name.innerText = user.displayName || "NO NAME";
                email.innerText = user.email;
            } else {
                window.location.href = "index.html";
            }
        });

        // 2. „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆ„Éó„É¨„Éì„É•„ÉºÂá¶ÁêÜ
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (2MB‰ª•‰∏ã)
                if(file.size > 2 * 1024 * 1024) {
                    alert("ÁîªÂÉè„Çµ„Ç§„Ç∫„ÅØ2MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    return;
                }
                selectedFile = file;
                img.src = URL.createObjectURL(file); // „Éó„É¨„Éì„É•„Éº
                uploadBtn.style.display = 'block';   // „Éú„Çø„É≥Ë°®Á§∫
            }
        });

        // 3. „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å
        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile || !currentUser) return;

            uploadBtn.innerText = "UPLOADING...";
            uploadBtn.disabled = true;

            try {
                // Storage„ÅÆ‰øùÂ≠òÂ†¥ÊâÄ: users/{uid}/profile.jpg
                // Êã°ÂºµÂ≠ê„Å´Èñ¢„Çè„Çâ„Åö profile.jpg „Å®„Åó„Å¶‰∏äÊõ∏„Åç‰øùÂ≠ò„Åô„Çã„Åì„Å®„ÅßÂÆπÈáèÁØÄÁ¥Ñ
                const storageRef = ref(storage, `users/${currentUser.uid}/profile.jpg`);
                
                await uploadBytes(storageRef, selectedFile);
                const photoURL = await getDownloadURL(storageRef);

                // AuthÊÉÖÂ†±Êõ¥Êñ∞
                await updateProfile(currentUser, { photoURL: photoURL });

                // FirestoreÊÉÖÂ†±Êõ¥Êñ∞ (ÈáçË¶Å: „Çø„Ç§„É†„É©„Ç§„É≥„ÅÆ„Ç¢„Ç§„Ç≥„É≥Áî®)
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { photoURL: photoURL });

                alert("„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü");
                location.reload(); // ÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶ÂèçÊò†

            } catch (error) {
                console.error(error);
                alert("„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: " + error.message);
                uploadBtn.innerText = "Â§âÊõ¥„Çí‰øùÂ≠ò„Åô„Çã";
                uploadBtn.disabled = false;
            }
        });

        // 4. „É≠„Ç∞„Ç¢„Ç¶„Éà
        document.getElementById('logout-btn').addEventListener('click', () => {
            if(confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                signOut(auth).then(() => window.location.href = "index.html");
            }
        });
    </script>
</body>
</html>