<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOSER | Timeline</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { gold: '#C5A059', dark: '#111111' }, fontFamily: { cinzel: ['Cinzel', 'serif'], noto: ['Noto Serif JP', 'serif'] } }
            }
        }
    </script>
</head>
<body class="bg-black text-white pb-20">
    <header class="fixed top-0 w-full bg-black/90 backdrop-blur border-b border-gray-800 z-50 p-4 flex justify-between items-center">
        <div class="text-xl font-cinzel text-gold tracking-widest cursor-pointer" onclick="location.reload()">TIMELINE</div>
        <div style="display:flex; gap:15px; align-items:center;">
            <a href="post.html" class="border border-gold text-gold px-3 py-1 text-xs font-cinzel font-bold hover:bg-gold hover:text-black transition">RECORD</a>
            <a href="profile.html">
                <div class="w-8 h-8 rounded-full border border-gold bg-gray-900 flex items-center justify-center overflow-hidden">
                    <img id="header-avatar" src="" class="w-full h-full object-cover hidden">
                </div>
            </a>
        </div>
    </header>

    <div class="container mx-auto px-4 pt-24 pb-10 max-w-2xl">
        <div class="relative flex justify-center items-end border-b border-gray-800 mb-8">
            <div class="flex font-cinzel text-sm">
                <div class="px-4 py-3 cursor-pointer text-gold border-b-2 border-gold tab-item" onclick="switchTab('main', this)">MAIN</div>
                <div class="px-4 py-3 cursor-pointer text-gray-500 hover:text-gold transition tab-item" onclick="switchTab('elite', this)">ELITE</div>
                <div class="px-4 py-3 cursor-pointer text-gray-500 hover:text-gold transition tab-item" onclick="switchTab('spirit', this)">SPIRIT</div>
            </div>
            
            <div class="absolute right-0 bottom-0 px-2 py-3 cursor-pointer text-gray-500 hover:text-gold transition" id="open-search-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>

        <div id="active-filters" class="hidden mb-6 flex flex-wrap gap-2 justify-center">
            <span class="text-xs text-gray-500 font-cinzel self-center mr-2">FILTERS:</span>
            <button id="clear-filters" class="text-xs border border-red-900 text-red-500 px-2 py-1 hover:bg-red-900 transition">CLEAR ALL</button>
        </div>

        <div id="posts-container" class="space-y-6">
            <p class="text-center text-gray-600 mt-10">LOADING...</p>
        </div>
    </div>

    <div id="search-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-dark border border-gray-700 w-full max-w-md p-6 rounded relative">
            <button id="close-search-modal" class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl"> ✕ </button>
            <h3 class="text-gold font-cinzel mb-6 text-center text-xl border-b border-gray-800 pb-4">SEARCH FILTER</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gold mb-1 font-cinzel">PHASE</label>
                    <select id="s-situation" class="w-full bg-black border border-gray-700 text-white text-sm p-2 focus:border-gold outline-none">
                        <option value="">ALL</option>
                        <option value="Approach">1. アプローチ</option>
                        <option value="Hearing">2. ヒアリング</option>
                        <option value="Presentation">3. プレゼンテーション</option>
                        <option value="Objection">4. オブジェクション</option>
                        <option value="Closing">5. クロージング</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gold mb-1 font-cinzel">TARGET</label>
                    <select id="s-target" class="w-full bg-black border border-gray-700 text-white text-sm p-2 focus:border-gold outline-none">
                        <option value="">ALL</option>
                        <option value="Economic Buyer">決裁者</option>
                        <option value="Champion">選定者・推進者</option>
                        <option value="End User">実務担当者</option>
                        <option value="Gatekeeper">ゲートキーパー</option>
                        <option value="Technical Buyer">専門家</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gold mb-1 font-cinzel">PRICE</label>
                    <select id="s-price" class="w-full bg-black border border-gray-700 text-white text-sm p-2 focus:border-gold outline-none">
                        <option value="">ALL</option>
                        <option value="~100k">〜10万円未満</option>
                        <option value="100k-500k">10万円 〜 50万円</option>
                        <option value="500k-1m">50万円 〜 100万円</option>
                        <option value="1m-3m">100万円 〜 300万円</option>
                        <option value="3m-10m">300万円 〜 1,000万円</option>
                        <option value="10m~">1,000万円以上</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gold mb-1 font-cinzel">INDUSTRY</label>
                    <select id="s-industry" class="w-full bg-black border border-gray-700 text-white text-sm p-2 focus:border-gold outline-none">
                        <option value="">ALL</option>
                        <option value="IT/Web">1. IT・通信・Web</option>
                        <option value="Energy">2. 環境・エネルギー</option>
                        <option value="RealEstate">3. 不動産・建設</option>
                        <option value="Finance">4. 金融・保険</option>
                        <option value="HR">5. 人材・教育・HR</option>
                        <option value="Ad/Marketing">6. 広告・出版</option>
                        <option value="Manufacturing">7. 自動車・製造</option>
                        <option value="Consulting">8. コンサル・専門職</option>
                        <option value="Retail">9. 小売・生活関連</option>
                        <option value="Other">10. その他</option>
                    </select>
                </div>
            </div>

            <button id="exec-search-btn" class="w-full bg-gold text-black font-cinzel py-3 font-bold hover:bg-yellow-600 transition mt-8">SEARCH</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, where, getDocs, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmPN0z032Uo_ONsronn3smkIixRnBReJw",
            authDomain: "closer-official.firebaseapp.com",
            projectId: "closer-official",
            storageBucket: "closer-official.firebasestorage.app",
            messagingSenderId: "1039215613610",
            appId: "1:1039215613610:web:540ef7a026714e28dbe2d3",
            measurementId: "G-LYK0THB2Z2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentCategory = 'main';
        let currentFilters = {};

        const searchModal = document.getElementById('search-modal');
        const openSearchBtn = document.getElementById('open-search-btn');
        const closeSearchBtn = document.getElementById('close-search-modal');
        const execSearchBtn = document.getElementById('exec-search-btn');
        const activeFiltersArea = document.getElementById('active-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');

        openSearchBtn.addEventListener('click', () => searchModal.classList.remove('hidden'));
        closeSearchBtn.addEventListener('click', () => searchModal.classList.add('hidden'));
        
        execSearchBtn.addEventListener('click', () => {
            currentFilters = {
                situation: document.getElementById('s-situation').value,
                target: document.getElementById('s-target').value,
                price: document.getElementById('s-price').value,
                industry: document.getElementById('s-industry').value
            };
            updateFilterUI();
            loadPosts(currentCategory);
            searchModal.classList.add('hidden');
        });

        clearFiltersBtn.addEventListener('click', () => {
            document.getElementById('s-situation').value = "";
            document.getElementById('s-target').value = "";
            document.getElementById('s-price').value = "";
            document.getElementById('s-industry').value = "";
            currentFilters = {};
            updateFilterUI();
            loadPosts(currentCategory);
        });

        function updateFilterUI() {
            const keys = Object.keys(currentFilters);
            const activeKeys = keys.filter(k => currentFilters[k]);
            
            Array.from(activeFiltersArea.children).forEach(child => {
                if(child.id !== 'clear-filters' && !child.classList.contains('text-xs')) {
                    child.remove();
                }
            });

            if (activeKeys.length > 0) {
                activeFiltersArea.classList.remove('hidden');
                activeKeys.forEach(key => {
                    const val = currentFilters[key];
                    const badge = document.createElement('span');
                    badge.className = "text-[10px] border border-gold text-gold px-2 py-1 font-cinzel";
                    badge.innerText = val;
                    activeFiltersArea.insertBefore(badge, clearFiltersBtn);
                });
            } else {
                activeFiltersArea.classList.add('hidden');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const avatar = document.getElementById('header-avatar');
                if(avatar) {
                    avatar.src = user.photoURL || "https://via.placeholder.com/40?text=U";
                    avatar.classList.remove('hidden');
                }
                loadPosts(currentCategory);
            } else {
                window.location.href = "index.html";
            }
        });

        window.switchTab = (category, el) => {
            currentCategory = category;
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('text-gold', 'border-b-2', 'border-gold');
                item.classList.add('text-gray-500');
            });
            el.classList.remove('text-gray-500');
            el.classList.add('text-gold', 'border-b-2', 'border-gold');
            loadPosts(category);
        }

        async function loadPosts(category) {
            const container = document.getElementById('posts-container');
            container.innerHTML = "<p class='text-center text-gray-600 mt-10'>LOADING...</p>";

            try {
                let q = query(
                    collection(db, "posts"),
                    where("category", "==", category)
                );

                if (currentFilters.situation) q = query(q, where("situation", "==", currentFilters.situation));
                if (currentFilters.target) q = query(q, where("target", "==", currentFilters.target));
                if (currentFilters.price) q = query(q, where("price", "==", currentFilters.price));
                if (currentFilters.industry) q = query(q, where("industry", "==", currentFilters.industry));

                q = query(q, orderBy("createdAt", "desc"));
                
                const querySnapshot = await getDocs(q);
                container.innerHTML = "";
                
                if (querySnapshot.empty) {
                    container.innerHTML = "<p class='text-center text-gray-600 mt-10'>NO POSTS FOUND</p>";
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const post = docSnap.data();
                    container.appendChild(createPostCard(post, docSnap.id));
                });
            } catch (error) {
                console.error("Error:", error);
                if (error.message.includes("requires an index")) {
                    container.innerHTML = "<p class='text-center text-red-500 mt-10 text-xs'>【開発者用】<br>複合クエリのインデックスが必要です。<br>ブラウザのコンソール(F12)を開き、<br>表示されたURLをクリックして作成してください。</p>";
                } else {
                    container.innerHTML = "<p class='text-center text-red-500 mt-10'>LOAD ERROR</p>";
                }
            }
        }

        function createPostCard(post, docId) {
            const div = document.createElement('div');
            div.className = 'bg-dark border border-gray-800 p-5 rounded-sm cursor-pointer hover:border-gray-700 transition relative group';
            div.onclick = (e) => {
                if(e.target.closest('.vote-btn')) return;
                window.location.href = `detail.html?id=${docId}`;
            };
            
            let dateStr = "Just now";
            if (post.createdAt && typeof post.createdAt.toDate === 'function') {
                dateStr = post.createdAt.toDate().toLocaleDateString('ja-JP');
            }
            
            const authorImg = post.authorPhoto || "https://via.placeholder.com/40?text=U";
            const authorName = post.authorName || "Unknown";

            let html = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <img src="${authorImg}" class="w-8 h-8 rounded-full border border-gray-700 object-cover">
                        <div>
                            <div class="font-cinzel text-gold text-xs tracking-wider">${escapeHtml(authorName)}</div>
                            <div class="text-[10px] text-gray-500">${dateStr}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <button class="vote-btn border border-gray-700 text-gray-500 hover:text-gold hover:border-gold px-3 py-1 text-xs font-cinzel transition z-10 relative" id="btn-${docId}">
                            VOTE ★ <span class="like-count">${post.likes || 0}</span>
                        </button>
                    </div>
                </div>
            `;

            if (post.category === 'spirit') {
                html += `
                    <div class="text-sm text-gray-300 whitespace-pre-wrap leading-relaxed line-clamp-3">${escapeHtml(post.solution)}</div>
                `;
            } else {
                html += `<div class="flex flex-wrap gap-2 mb-3">`;
                const tags = [post.situation, post.target, post.price, post.industry];
                tags.forEach(tag => {
                    if(tag) html += `<span class="text-[10px] border border-gray-600 text-gray-400 px-2 py-1 rounded font-cinzel">${escapeHtml(tag)}</span>`;
                });
                html += `</div>`;

                html += `
                    <div class="mb-2">
                        <div class="text-[10px] text-gold font-cinzel mb-1">PROBLEM</div>
                        <div class="text-sm text-gray-300 leading-relaxed whitespace-pre-wrap line-clamp-3">${escapeHtml(post.problem)}</div>
                    </div>
                `;
                
                html += `
                    <div class="text-center mt-4">
                        <span class="text-[10px] text-gray-600 group-hover:text-gold transition">▼ CLICK TO READ SOLUTION</span>
                    </div>
                `;
            }

            div.innerHTML = html;

            const btn = div.querySelector(`#btn-${docId}`);
            if(btn) {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    votePost(docId, btn);
                };
            }

            return div;
        }

        async function votePost(docId, btn) {
            if (btn.disabled) return;
            btn.disabled = true;
            try {
                const postRef = doc(db, "posts", docId);
                await updateDoc(postRef, { likes: increment(1) });
                const countSpan = btn.querySelector('.like-count');
                if(countSpan) countSpan.innerText = parseInt(countSpan.innerText) + 1;
                btn.classList.remove('text-gray-500', 'border-gray-700');
                btn.classList.add('text-gold', 'border-gold');
            } catch (error) {
                console.error("Vote Error:", error);
                btn.disabled = false;
            }
        }

        function escapeHtml(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(match) {
                const escape = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
                return escape[match];
            });
        }
    </script>
</body>
</html>