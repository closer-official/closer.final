<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOSER | Detail</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { 
                    colors: { gold: '#C5A059', dark: '#111111' }, 
                    fontFamily: { cinzel: ['Cinzel', 'serif'], noto: ['Noto Serif JP', 'serif'] },
                }
            }
        }
    </script>
    <style>
        .btn-selected {
            background-color: #C5A059 !important;
            color: #000 !important;
            border-color: #C5A059 !important;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.4);
            pointer-events: none; /* 選択後は操作不可 */
        }
        /* 保存ボタンは解除可能にするためpointer-eventsは制御しないが、selectedクラスは共有 */
        .btn-save-selected {
            background-color: #C5A059 !important;
            color: #000 !important;
            border-color: #C5A059 !important;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.4);
        }
        .btn-locked {
            opacity: 0.3;
            pointer-events: none; /* ロックされたボタン */
            border-color: #333 !important;
        }
        .btn-inactive {
            opacity: 0.6;
        }
        .btn-inactive:hover { opacity: 1.0; }
        
        .blind-blur { filter: blur(6px); user-select: none; transition: filter 0.5s ease; }
        .blind-reveal { filter: blur(0); }
    </style>
</head>
<body class="bg-black text-white pb-20">
    <header class="fixed top-0 w-full bg-black/90 backdrop-blur border-b border-gray-800 z-50 p-4 flex justify-between items-center">
        <div class="text-xl font-cinzel text-gold tracking-widest">DETAILS</div>
        <a href="timeline.html" class="border border-gold text-gold px-3 py-1 text-xs font-cinzel font-bold hover:bg-gold hover:text-black transition">BACK</a>
    </header>

    <div class="container mx-auto px-4 pt-24 pb-10 max-w-2xl" id="detail-container">
        <p class="text-center text-gray-600 mt-10">LOADING...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmPN0z032Uo_ONsronn3smkIixRnBReJw",
            authDomain: "closer-official.firebaseapp.com",
            projectId: "closer-official",
            storageBucket: "closer-official.firebasestorage.app",
            messagingSenderId: "1039215613610",
            appId: "1:1039215613610:web:540ef7a026714e28dbe2d3",
            measurementId: "G-LYK0THB2Z2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentPostId = null;

        // 状態管理用グローバル変数
        let currentLogic = null; // 'useful' | 'not_useful' | null
        let currentSaved = false;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loadPost();
            } else {
                window.location.href = "index.html";
            }
        });

        async function loadPost() {
            const urlParams = new URLSearchParams(window.location.search);
            currentPostId = urlParams.get('id');
            const container = document.getElementById('detail-container');

            if (!currentPostId) {
                container.innerHTML = "<p class='text-center text-red-500'>POST ID NOT FOUND</p>";
                return;
            }

            try {
                // 1. 投稿データ取得
                const docRef = doc(db, "posts", currentPostId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    container.innerHTML = "<p class='text-center text-gray-500'>Post removed or not found.</p>";
                    return;
                }
                const postData = docSnap.data();

                // 2. 自分の投票データ取得 (統合版 votes/{uid})
                const voteRef = doc(db, "posts", currentPostId, "votes", currentUser.uid);
                const voteSnap = await getDoc(voteRef);
                const myVoteData = voteSnap.exists() ? voteSnap.data() : null;

                // ★初期状態をグローバル変数にセット (ここが修正ポイント)
                if (myVoteData) {
                    currentLogic = myVoteData.logic || null;
                    currentSaved = myVoteData.saved || false;
                } else {
                    currentLogic = null;
                    currentSaved = false;
                }

                renderPost(postData, container, myVoteData);

            } catch (error) {
                console.error("Error loading post:", error);
                container.innerHTML = "<p class='text-center text-red-500'>ERROR LOADING POST</p>";
            }
        }

        function renderPost(post, container, voteData) {
            let dateStr = "Just now";
            if (post.createdAt && typeof post.createdAt.toDate === 'function') {
                dateStr = post.createdAt.toDate().toLocaleDateString('ja-JP');
            }
            
            // ★ ブラインド判定: 評価(logic)があるか、またはSpiritでsavedMe済みか
            const hasLogic = voteData && voteData.logic; 
            const hasSpirit = post.category === 'spirit' && voteData && voteData.saved;
            const isRevealed = hasLogic || hasSpirit;

            const realAuthorName = post.authorName || "Unknown";
            const realAuthorImg = post.authorPhoto || "https://via.placeholder.com/40?text=U";
            const realScore = (post.score || 0).toFixed(1);

            const displayAuthorName = isRevealed ? realAuthorName : "SECRET";
            const displayAuthorImg = isRevealed ? realAuthorImg : "https://via.placeholder.com/40?text=?";
            const displayScore = isRevealed ? realScore : "???";

            const textClass = isRevealed ? "text-gold" : "text-gray-600";

            let html = `
                <div class="bg-dark border border-gray-800 p-6 rounded-sm relative">
                    <div class="flex justify-between items-start mb-6 border-b border-gray-800 pb-4">
                        <div class="flex items-center gap-4">
                            <div class="relative w-10 h-10 overflow-hidden rounded-full border border-gray-700">
                                <img id="reveal-img" src="${displayAuthorImg}" 
                                     class="w-full h-full object-cover transition-all duration-500 ${isRevealed ? '' : 'grayscale'}"
                                     data-real-src="${realAuthorImg}">
                            </div>
                            <div>
                                <div id="reveal-name" class="font-cinzel text-sm tracking-wider transition-all duration-500 ${isRevealed ? 'text-gold' : 'text-gray-500'}"
                                     data-real-name="${escapeHtml(realAuthorName)}">
                                    ${escapeHtml(displayAuthorName)}
                                </div>
                                <div class="text-xs text-gray-500">${dateStr}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-600 font-cinzel">SCORE: 
                                <span id="reveal-score" class="text-lg font-bold transition-all duration-500 ${textClass}"
                                      data-real-score="${realScore}">
                                    ${displayScore}
                                </span>
                            </div>
                        </div>
                    </div>
            `;

            if (post.category === 'spirit') {
                const isSaved = voteData && voteData.saved;
                html += `
                    <div class="text-base text-gray-200 whitespace-pre-wrap leading-loose mb-8">${escapeHtml(post.solution)}</div>
                    <div class="flex justify-center mt-8">
                        <button class="btn-spirit w-full py-4 text-base ${isSaved ? 'btn-save-selected' : 'btn-inactive'}" 
                            onclick="handleSpiritVote(this)">
                            SAVED ME (救われた) ★ <span class="count">${post.savedMe || 0}</span>
                        </button>
                    </div>
                `;
            } else {
                // Logic View
                const logic = voteData ? voteData.logic : null; // 'useful' or 'not_useful' or null
                const saved = voteData ? voteData.saved : false;

                // クラス判定ロジック
                // 1. Logicボタン: 一度押したら locked (btn-selected か btn-locked)
                // 2. Saveボタン: 'not_useful' なら locked, それ以外なら toggle可能
                
                let usefulClass = "btn-inactive";
                let uselessClass = "btn-inactive";
                let saveClass = saved ? "btn-save-selected" : "btn-inactive";
                let saveDisabled = false;

                if (logic === 'useful') {
                    usefulClass = "btn-selected"; // 選択済み＆ロック
                    uselessClass = "btn-locked";  // ロック
                    // Saveは押せる
                } else if (logic === 'not_useful') {
                    uselessClass = "btn-selected"; // 選択済み＆ロック
                    usefulClass = "btn-locked";    // ロック
                    saveClass = "btn-locked";      // ロック (保存不可)
                    saveDisabled = true;
                }

                html += `
                    <div class="flex flex-wrap gap-2 mb-6">`;
                const tags = [post.situation, post.target, post.price, post.industry];
                tags.forEach(tag => {
                    if(tag) html += `<span class="text-xs border border-gray-600 text-gray-400 px-3 py-1 rounded font-cinzel">${escapeHtml(tag)}</span>`;
                });
                html += `</div>`;

                html += `
                    <div class="mb-6">
                        <div class="text-xs text-gold font-cinzel mb-2">PROBLEM</div>
                        <div class="text-base text-gray-300 leading-relaxed whitespace-pre-wrap p-4 bg-black/50 rounded border border-gray-900">${escapeHtml(post.problem)}</div>
                    </div>

                    <div class="mb-6">
                        <div class="text-xs text-gold font-cinzel mb-2">SOLUTION</div>
                        <div class="text-base text-white leading-loose whitespace-pre-wrap p-4 bg-gray-900/50 rounded border border-gray-700 font-noto">${escapeHtml(post.solution)}</div>
                    </div>
                    
                    <div class="mb-8">
                        <div class="text-xs text-gold font-cinzel mb-2">EXPLANATION</div>
                        <div class="text-sm text-gray-400 leading-relaxed whitespace-pre-wrap p-4 border-l-2 border-gray-700">${escapeHtml(post.explanation)}</div>
                    </div>

                    <div class="border-t border-gray-800 pt-6 mt-6">
                        <p class="text-center text-xs text-gray-500 font-cinzel mb-4">EVALUATE TO UNLOCK SCORE</p>
                        <div class="grid grid-cols-3 gap-3">
                            <button id="btn-useless" class="btn-logic py-3 text-sm hover:text-red-400 hover:border-red-400 transition-all ${uselessClass}" 
                                onclick="handleLogicVote('not_useful', this)">
                                使えない
                            </button>
                                
                            <button id="btn-useful" class="btn-logic py-3 text-sm hover:text-blue-400 hover:border-blue-400 transition-all ${usefulClass}" 
                                onclick="handleLogicVote('useful', this)">
                                使える
                            </button>
                                
                            <button id="btn-save" class="btn-logic py-3 text-sm hover:text-gold hover:border-gold transition-all ${saveClass}" 
                                onclick="handleSaveVote(this)" ${saveDisabled ? 'disabled' : ''}>
                                保存
                            </button>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        // Logicボタン用ハンドラ
        window.handleLogicVote = async (logicType, btn) => {
            if (!currentUser || !currentPostId) return;
            // ロックチェック
            if (btn.classList.contains('btn-locked') || btn.classList.contains('btn-selected')) return;

            // UI即時更新
            const uselessBtn = document.getElementById('btn-useless');
            const usefulBtn = document.getElementById('btn-useful');
            const saveBtn = document.getElementById('btn-save');

            // 1. Logic状態の確定
            if (logicType === 'not_useful') {
                uselessBtn.classList.add('btn-selected');
                usefulBtn.classList.add('btn-locked');
                usefulBtn.classList.remove('btn-inactive');
                // 排他制御: 使えないなら保存不可
                saveBtn.classList.remove('btn-save-selected', 'btn-inactive');
                saveBtn.classList.add('btn-locked');
                saveBtn.disabled = true;
                currentSaved = false; // 強制オフ
            } else {
                usefulBtn.classList.add('btn-selected');
                uselessBtn.classList.add('btn-locked');
                uselessBtn.classList.remove('btn-inactive');
                // 使えるなら保存は可能（現状維持）
            }
            currentLogic = logicType;

            // 情報開示
            revealInfo();

            // スコア計算とDB更新を実行
            await executeVoteUpdate();
        };

        // Saveボタン用ハンドラ
        window.handleSaveVote = async (btn) => {
            if (!currentUser || !currentPostId) return;
            if (btn.classList.contains('btn-locked')) return;

            // Toggle
            const isSelected = btn.classList.contains('btn-save-selected');
            if (isSelected) {
                btn.classList.remove('btn-save-selected');
                btn.classList.add('btn-inactive');
                currentSaved = false;
            } else {
                btn.classList.add('btn-save-selected');
                btn.classList.remove('btn-inactive');
                currentSaved = true;
            }

            await executeVoteUpdate();
        };

        // Spirit用
        window.handleSpiritVote = async (btn) => {
             if (!currentUser || !currentPostId) return;
             if (btn.classList.contains('btn-save-selected')) return; // 重複防止

             btn.classList.add('btn-save-selected');
             btn.classList.remove('btn-inactive');
             currentSaved = true; // SpiritではLogicがないのでSavedのみ

             revealInfo();
             await executeVoteUpdate(true);
        };


        // 統合DB更新ロジック
        async function executeVoteUpdate(isSpirit = false) {
            try {
                // 1. 現在の投票データを取得 (Old Score計算用)
                const voteRef = doc(db, "posts", currentPostId, "votes", currentUser.uid);
                const voteSnap = await getDoc(voteRef);
                const oldData = voteSnap.exists() ? voteSnap.data() : { logic: null, saved: false, value: 0 };
                
                // 初回ロード時の変数がloadPostで初期化されているので、
                // 強制的な上書きロジック（以下）は削除またはコメントアウトします。
                // これにより「保存解除したのに強制的にtrueに戻る」バグを修正。
                /*
                if (currentLogic === null && !isSpirit) currentLogic = oldData.logic;
                if (currentSaved === false && oldData.saved) currentSaved = true; 
                */

                // 2. 新しいスコア値の決定
                let newValue = 0;
                
                if (isSpirit) {
                    newValue = 10; // Spiritの固定点 (仮)
                } else {
                    // Logic Logic
                    // 優先順位: 保存(5.0) > 使える(4.5) > 使えない(1.5)
                    if (currentSaved) {
                        newValue = 5.0; // 保存があれば5.0採用
                    } else if (currentLogic === 'useful') {
                        newValue = 4.5; // 保存解除されたら使えるの点数
                    } else if (currentLogic === 'not_useful') {
                        newValue = 1.5;
                    }
                }

                // 3. 差分計算
                const oldValue = oldData.value || 0;
                const diff = newValue - oldValue;

                // 4. Voteデータ保存
                const newVoteData = {
                    uid: currentUser.uid,
                    logic: currentLogic,
                    saved: currentSaved,
                    value: newValue,
                    updatedAt: serverTimestamp()
                };
                // Spiritの場合はtypeも含める
                if(isSpirit) newVoteData.type = 'spirit';

                await setDoc(voteRef, newVoteData);

                // 5. Post本体更新 (カウンタ & スコア)
                const postRef = doc(db, "posts", currentPostId);
                const updates = {
                    score: increment(diff)
                };

                // カウンタ制御: 保存状態が変化した場合のみ増減
                if (currentSaved !== oldData.saved) {
                    if (isSpirit) {
                        updates.savedMe = increment(currentSaved ? 1 : -1);
                    } else {
                        updates.saves = increment(currentSaved ? 1 : -1);
                    }
                }
                
                await updateDoc(postRef, updates);

            } catch (error) {
                console.error("Vote Transaction Failed:", error);
            }
        }

        function revealInfo() {
            const imgEl = document.getElementById('reveal-img');
            const nameEl = document.getElementById('reveal-name');
            const scoreEl = document.getElementById('reveal-score');
            
            if (scoreEl && scoreEl.innerText === "???") {
                if(imgEl && imgEl.dataset.realSrc) {
                    imgEl.src = imgEl.dataset.realSrc;
                    imgEl.classList.remove('grayscale');
                }
                if(nameEl && nameEl.dataset.realName) {
                    nameEl.innerText = nameEl.dataset.realName;
                    nameEl.classList.remove('text-gray-500');
                    nameEl.classList.add('text-gold');
                }
                if(scoreEl && scoreEl.dataset.realScore) {
                    scoreEl.innerText = scoreEl.dataset.realScore;
                    scoreEl.classList.remove('text-gray-600');
                    scoreEl.classList.add('text-gold');
                }
            }
        }

        function escapeHtml(str) {
            if (!str) return "";
            return str.replace(/[&<>"']/g, function(match) {
                const escape = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
                return escape[match];
            });
        }
    </script>
</body>
</html>